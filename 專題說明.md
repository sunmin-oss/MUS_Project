# 藥物辨識系統 (MUS_Project) - 專題說明文件

## 📋 專題簡介

這是一個基於影像辨識技術的藥物識別系統，使用者可以透過拍攝藥物照片，系統會自動辨識並回傳最相似的藥物資訊。系統同時提供名稱搜尋、特徵搜尋等多種查詢方式。

---

## 🎯 核心功能

### 1. **藥物圖片辨識** (主要功能)
- 上傳藥物照片，系統自動辨識
- 使用 4 種特徵進行比對：
  - **顏色** (40%) - HSV 色彩空間直方圖
  - **形狀** (30%) - 圓度與長寬比
  - **紋理** (20%) - LBP 局部二值模式
  - **刻痕** (10%) - ORB 特徵點比對
- 回傳 Top-K 最相似的藥物候選

### 2. **藥物名稱搜尋**
- 支援中文、英文名稱搜尋
- 模糊比對 + 同音字/異體字處理
- 例如：輸入 "阿斯匹靈" 可找到 "阿斯匹林"

### 3. **藥物特徵搜尋**
- 根據外觀特徵篩選 (形狀、顏色、標記)
- 形狀精確匹配，顏色模糊匹配
- 可多條件組合查詢

### 4. **藥物資料管理**
- C# WinForms 管理工具
- 新增、編輯、刪除藥物資料
- 圖片上傳與管理

---

## 📁 專案結構

```
MUS_Project/
│
├── 主要程式檔案
│   ├── app.py                    # Flask 後端伺服器 (7 個 API 端點)
│   ├── database_query.py         # 資料庫查詢模組 (CRUD + 模糊搜尋)
│   ├── image_recognition.py      # 影像辨識引擎 (OpenCV + 特徵比對)
│   ├── ocr_module.py            # OCR 文字辨識模組 (PaddleOCR)
│   └── index.html               # 前端使用者介面
│
├── 資料與資料庫
│   ├── drug_recognition.db      # SQLite 資料庫 (藥物資訊 + 圖片關聯)
│   ├── medicine_data.csv        # 原始藥物資料 CSV
│   └── medicine_photos/         # 藥物圖片資料夾
│
├── 工具程式
│   ├── check_db_structure.py    # 資料庫結構檢查工具
│   ├── check_drugs.py           # 快速藥物查詢工具
│   └── update_split_images.py   # 圖片分割後資料庫同步工具
│
├── 管理工具 (C# WinForms)
│   └── admin_tool/              # 藥物資料庫管理系統
│       ├── MainForm.cs          # 主畫面 (搜尋、瀏覽)
│       ├── DrugEditForm.cs      # 編輯畫面 (新增、修改)
│       └── ImageViewerForm.cs   # 圖片檢視器
│
└── 文件
    ├── README.md                # 專案總說明
    ├── QUICK_REFERENCE.md       # 快速參考指南
    └── docs/                    # 詳細技術文件
```

---

## 🔧 技術架構

### 後端 (Python)
- **Flask 2.x** - Web 框架，提供 RESTful API
- **OpenCV 4.x** - 影像處理與特徵提取
- **SQLite 3** - 輕量級資料庫 (4775 張圖片，4394 種藥物)
- **NumPy** - 數值運算與陣列處理
- **PaddleOCR** - 文字辨識 (選用功能)

### 前端
- **HTML5 + JavaScript** - 純前端，無額外框架
- **Fetch API** - 與後端溝通
- **Canvas API** - 圖片預覽與處理

### 管理工具 (C#)
- **.NET 6.0** - Windows 桌面應用程式框架
- **WinForms** - 圖形化介面
- **System.Data.SQLite** - SQLite 資料庫存取

---

## 🚀 快速開始

### 1. 安裝 Python 依賴
```powershell
cd "d:\大學\專題\MUS_Project"
pip install -r requirements.txt
```

### 2. 啟動 Flask 後端
```powershell
python app.py
```
伺服器會在 `http://localhost:3000` 啟動

### 3. 開啟前端介面
瀏覽器打開: `http://localhost:3000`

### 4. 使用管理工具 (選用)
```powershell
cd admin_tool
dotnet run
```

---

## 📊 資料庫結構

### 主要資料表

#### **drugs** (藥物基本資料)
- `id` - 藥物 ID (主鍵)
- `chinese_name` - 中文名稱
- `english_name` - 英文名稱
- `license_number` - 許可證字號
- `shape` - 形狀 (圓形、橢圓形、方形...)
- `color` - 顏色
- `mark` - 刻痕描述
- `label_front` / `label_back` - 正反面標記
- 臨床資訊欄位: `indication`, `dosage`, `contraindication` 等

#### **drug_images** (藥物圖片)
- `id` - 圖片 ID (主鍵)
- `drug_id` - 藥物 ID (外鍵)
- `image_filename` - 圖片檔名
- 支援一藥多圖 (例如: `藥名_1.jpg`, `藥名_2.jpg`)

---

## 🧪 辨識演算法詳解

### 特徵提取流程

```
輸入圖片
    ↓
[預處理] 調整大小、去噪
    ↓
[特徵提取] 並行提取 4 種特徵
    ├─ 顏色直方圖 (HSV 18×8×8 bins)
    ├─ 形狀特徵 (圓度、長寬比)
    ├─ LBP 紋理 (256 bins)
    └─ ORB 刻痕 (500 特徵點)
    ↓
[相似度計算] 與資料庫逐一比對
    ↓
[加權平均] 40% 顏色 + 30% 形狀 + 20% 紋理 + 10% 刻痕
    ↓
[懲罰機制] 形狀/顏色不符扣分 30-50%
    ↓
[排序] 取 Top-K 最相似結果
    ↓
輸出候選清單
```

### 效能優化策略

1. **特徵預載入**
   - 系統啟動時，背景執行緒預先計算所有資料庫圖片的特徵
   - 首次載入約 30-60 秒，後續即時響應

2. **特徵快取**
   - 已計算的特徵存於記憶體，避免重複運算
   - 降低 CPU 使用率 70%

3. **自動顏色篩選**
   - 從上傳圖片推估主要顏色
   - 縮小候選範圍至 20-30%

4. **延遲計算**
   - ORB 刻痕特徵僅在顏色相似度 ≥ 0.3 時計算
   - 節省 40% 運算時間

---

## 🔍 API 端點說明

### 1. `GET /api/search/name`
**藥物名稱搜尋**
- 參數: `q` (搜尋關鍵字), `limit` (筆數)
- 範例: `/api/search/name?q=普拿疼&limit=10`

### 2. `GET /api/search/features`
**外觀特徵搜尋**
- 參數: `color` (顏色), `shape` (形狀), `label` (標記)
- 範例: `/api/search/features?color=白色&shape=圓形`

### 3. `POST /api/recognize`
**圖片辨識**
- 參數: `image` (圖片檔案), `model` (模式), `top_k` (回傳數量)
- 支援模式: `auto`, `feature`, `ocr`, `prescription`

### 4. `GET /api/drug/<drug_id>`
**取得藥物詳細資訊**
- 回傳完整藥物資料 + 所有關聯圖片

### 5. `GET /api/statistics`
**資料庫統計資訊**
- 藥物總數、圖片總數、特徵分佈等

### 6. `POST /api/cancel`
**取消辨識請求**
- 參數: `request_id` (請求 ID)

### 7. `GET /api/progress/<request_id>`
**查詢辨識進度**
- 即時回報辨識進度 (用於進度條)

---

## ⚙️ 重要設定與參數

### 辨識權重配置 (在 `image_recognition.py` 中)
```python
# 預設權重
COLOR_WEIGHT = 0.40      # 顏色 40%
SHAPE_WEIGHT = 0.30      # 形狀 30%
TEXTURE_WEIGHT = 0.20    # 紋理 20%
IMPRINT_WEIGHT = 0.10    # 刻痕 10%
```

### 特徵提取參數
```python
# 顏色直方圖
HSV_BINS = [18, 8, 8]    # H:18, S:8, V:8

# ORB 特徵點
ORB_FEATURES = 500       # 最多 500 個特徵點

# LBP 紋理
LBP_RADIUS = 1           # 半徑 1 像素
LBP_POINTS = 8           # 8 個鄰居點
```

### 懲罰機制閾值
```python
# 形狀不符懲罰
SHAPE_MISMATCH_PENALTY = 0.5    # 扣 50% 分數

# 顏色不符懲罰
COLOR_MISMATCH_PENALTY = 0.3    # 扣 30% 分數
```

---

## 📝 常見問題 (FAQ)

### Q1: 首次辨識為何很慢？
**A:** 系統需要預載所有資料庫圖片的特徵 (約 4775 張)，首次啟動需等待 30-60 秒。特徵載入完成後，後續辨識會非常快 (通常 < 1 秒)。

### Q2: 如何提高辨識準確度？
**A:** 建議：
1. 提供清晰、光線充足的圖片
2. 確保藥物完整入鏡，背景簡潔
3. 手動指定形狀/顏色篩選條件
4. 將雙面藥物圖片分割成正反兩面

### Q3: 為何有些藥物有 2 張圖片？
**A:** 部分藥物有正反兩面不同的外觀，分開儲存可提高辨識準確度 20-30%。命名規則：`藥名_1.jpg` (正面), `藥名_2.jpg` (反面)。

### Q4: OCR 功能是否必要？
**A:** OCR 為選用功能，主要用於辨識處方籤文字。一般藥物辨識使用影像特徵比對即可，無需 OCR。

### Q5: 如何新增藥物資料？
**A:** 使用 C# 管理工具 (`admin_tool`)，提供圖形化介面進行新增、編輯、刪除操作。或直接編輯 `medicine_data.csv` 後重新匯入資料庫。

---

## 🛠️ 維護與更新

### 更新藥物圖片
1. 將新圖片放入 `medicine_photos/` 資料夾
2. 命名格式: `藥物中文名稱.jpg` 或 `藥物中文名稱_1.jpg`
3. 執行 `python update_split_images.py` 同步資料庫

### 檢查資料庫狀態
```powershell
python check_db_structure.py    # 查看資料表結構
python check_drugs.py           # 快速查詢藥物資料
```

### 重建特徵快取
刪除特徵快取後，系統會自動重新計算：
```powershell
# 重啟 Flask 伺服器，特徵會自動重新載入
python app.py
```

---

## 👥 團隊協作建議

### 程式碼修改前
1. 閱讀每個檔案開頭的功能說明註解
2. 理解主要函數的參數與回傳值
3. 測試修改後的功能是否正常

### 新增功能時
1. 遵循現有的程式碼風格
2. 添加詳細的註解說明
3. 更新相關文件 (README.md, QUICK_REFERENCE.md)

### 回報問題時
1. 描述問題發生的情境與步驟
2. 提供錯誤訊息與截圖
3. 說明預期行為與實際行為的差異

---

## 📚 延伸學習資源

### OpenCV 影像處理
- [OpenCV 官方教學](https://docs.opencv.org/4.x/d6/d00/tutorial_py_root.html)
- HSV 色彩空間、直方圖、特徵提取

### Flask Web 開發
- [Flask 官方文件](https://flask.palletsprojects.com/)
- RESTful API 設計、CORS 處理

### SQLite 資料庫
- [SQLite 官方文件](https://www.sqlite.org/docs.html)
- SQL 查詢、資料表設計

### 機器學習 (進階)
- 特徵工程與降維
- 深度學習影像分類 (CNN)
- 遷移學習 (Transfer Learning)

---

## 📞 聯絡資訊

**專題團隊**: MUS_Project 團隊  
**開發年份**: 2024-2025  
**專案類型**: 大學專題研究

---

## 📄 授權聲明

本專題僅供學術研究與教學使用，不得用於商業目的。藥物資料來源請遵守相關法規與授權條款。

---

**最後更新**: 2024年12月  
**文件版本**: v1.0
