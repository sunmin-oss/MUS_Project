<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>藥物辨識系統</title>
    <!-- SEO meta -->
    <meta name="description" content="智慧藥物辨識系統 — 以影像與文字搜尋藥物資訊,提供許可證字號、中文/英文名、形狀、顏色、劑型與圖片預覽。">
    <link rel="canonical" href="https://mus-project.vercel.app/"> <!-- 部署後請替換為實際公開網址 -->
    <meta name="robots" content="index, follow">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="智慧藥物辨識系統">
    <meta property="og:description" content="以影像與文字搜尋藥物資訊,支援中文拆詞模糊搜尋與圖片比對。">
    <meta property="og:url" content="https://mus-project.vercel.app/">
    <meta property="og:image" content="https://mus-project.vercel.app/og-image.png"> <!-- optional -->

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="智慧藥物辨識系統">
    <meta name="twitter:description" content="以影像與文字搜尋藥物資訊,支援中文拆詞模糊搜尋與圖片比對。">
    <meta name="twitter:image" content="https://mus-project.vercel.app/og-image.png">

    <!-- JSON-LD structured data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "智慧藥物辨識系統",
      "url": "https://mus-project.vercel.app/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://mus-project.vercel.app/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] {
            display: none;
        }
        /* 全畫面遮罩 */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="app" v-cloak>
        <!-- 導航欄 -->
        <nav class="bg-indigo-600 text-white shadow-lg">
            <div class="container mx-auto px-4 py-3 flex items-center justify-between">
                <a href="#" class="text-xl font-bold">智慧藥物辨識系統</a>
                <div class="flex items-center space-x-4">
                    <a href="#" class="hover:text-indigo-200" @click="setActivePage('home')">首頁</a>
                    <a href="#" class="hover:text-indigo-200" @click="setActivePage('search')">搜尋結果</a>
                    <a href="#" class="hover:text-indigo-200" @click="setActivePage('detail')">藥物詳情</a>
                    <a href="#" class="hover:text-indigo-200" @click="setActivePage('recognition')">圖片辨識</a>
                </div>
            </div>
        </nav>

        <!-- 首頁 -->
        <div v-if="activePage === 'home'" class="container mx-auto px-4 py-8">
            <h1 class="text-2xl font-bold text-center mb-8">歡迎使用智慧藥物辨識系統</h1>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- 圖片上傳區 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-indigo-600 text-white py-2 px-4">
                        <h2 class="text-lg font-semibold">藥物圖片辨識</h2>
                    </div>
                    <div class="p-4">
                        <!-- 辨識模式選擇 -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">辨識模式</label>
                            <select v-model="recognitionMode" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="auto">🤖 自動判斷（推薦）</option>
                                <option value="feature">🖼️ 影像特徵比對</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                <span v-if="recognitionMode === 'auto'">系統會自動選擇最適合的辨識方法</span>
                                <span v-else-if="recognitionMode === 'feature'">適合單顆藥物清晰照片</span>
                            </p>
                        </div>                        <!-- 形狀選擇 -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">藥物形狀 (選填)</label>
                            <select v-model="selectedShape" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="">不限制形狀</option>
                                <option value="圓形">⭕ 圓形</option>
                                <option value="橢圓形">🔵 橢圓形</option>
                                <option value="方形">🟦 方形</option>
                                <option value="長方形">▬ 長方形</option>
                                <option value="三角形">🔺 三角形</option>
                                <option value="菱形">🔶 菱形</option>
                                <option value="六角形">⬡ 六角形</option>
                                <option value="粉狀">💊 粉狀/顆粒</option>
                                <option value="膠囊">💊 膠囊</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">選擇後可提高辨識準確度</p>
                        </div>

                        <!-- 顏色選擇 -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">藥物顏色 (選填)</label>
                            <select v-model="selectedColor" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-600">
                                <option value="">不限制顏色</option>
                                <option value="白">⚪ 白色</option>
                                <option value="黃">🟡 黃色</option>
                                <option value="紅">🔴 紅色</option>
                                <option value="藍">🔵 藍色</option>
                                <option value="綠">🟢 綠色</option>
                                <option value="橘">🟠 橘色</option>
                                <option value="粉紅">🩷 粉紅色</option>
                                <option value="褐">🟤 褐色</option>
                                <option value="灰">⚫ 灰色</option>
                                <option value="紫">🟣 紫色</option>
                                <option value="透明">◯ 透明</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">選擇後可提高辨識準確度</p>
                        </div>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:bg-gray-50 transition"
                            @click="triggerFileInput">
                            <div v-if="!previewImage">
                                <i class="fas fa-image text-gray-400 text-4xl mb-2"></i>
                                <p class="text-gray-600">點擊上傳或拖放藥物圖片</p>
                                <p class="text-xs text-gray-500 mt-1">支援 PNG, JPG, GIF 格式</p>
                            </div>
                            <div v-else>
                                <img :src="previewImage" alt="藥物預覽" class="max-h-48 mx-auto rounded-lg">
                            </div>
                        </div>
                        <input type="file" ref="fileInput" class="hidden" accept="image/*" @change="handleFileChange" />
                        <button @click="identifyDrug"
                            class="w-full mt-4 py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
                            :disabled="!previewImage || isRecognizing">
                            辨識藥物
                        </button>
                    </div>
                </div>

                <!-- 藥物名稱搜尋 -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="bg-indigo-600 text-white py-2 px-4">
                        <h2 class="text-lg font-semibold">藥物名稱搜尋</h2>
                    </div>
                    <div class="p-4">
                        <div class="relative">
                            <input v-model="searchQuery" type="text"
                                class="w-full border border-gray-300 rounded-lg py-3 px-4 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-600"
                                placeholder="輸入藥物名稱或特徵..." @keyup.enter="searchDrug" />
                            <button @click="searchDrug"
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                        <div class="mt-6">
                            <h3 class="text-gray-600 font-medium mb-2">常見藥物:</h3>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="drug in commonDrugs" :key="drug" @click="searchQuery = drug; searchDrug()"
                                    class="bg-gray-200 hover:bg-gray-300 cursor-pointer px-3 py-1 rounded-full text-sm">{{
                                    drug }}</span>
                            </div>
                        </div>

                        <div class="mt-6" v-if="recentSearches.length > 0">
                            <h3 class="text-gray-600 font-medium mb-2">最近搜尋:</h3>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="drug in recentSearches" :key="drug"
                                    @click="searchQuery = drug; searchDrug()"
                                    class="bg-gray-200 hover:bg-gray-300 cursor-pointer px-3 py-1 rounded-full text-sm">{{
                                    drug }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 搜索結果頁 -->
        <div v-if="activePage === 'search'" class="container mx-auto px-4 py-8">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">搜尋結果: "{{ searchQuery }}"</h1>
                <div class="relative w-64">
                    <input v-model="searchQuery" type="text"
                        class="w-full border border-gray-300 rounded-lg py-2 px-4 pr-10 focus:outline-none focus:ring-2 focus:ring-indigo-600"
                        placeholder="重新搜尋..." @keyup.enter="searchDrug" />
                    <button @click="searchDrug"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white p-1 rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 搜索結果項目 -->
                <div v-for="(drug, index) in searchResults" :key="index"
                    class="bg-white rounded-lg shadow-md overflow-hidden transition-transform hover:scale-102 hover:shadow-lg">
                    <img v-if="drug.imageUrl" :src="drug.imageUrl" :alt="drug.name" class="w-full h-48 object-cover">
                    <div v-else class="w-full h-48 bg-gray-200 flex items-center justify-center">
                        <span class="text-gray-400">無圖片</span>
                    </div>
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800">{{ drug.name }}</h3>
                        <p class="text-xs text-gray-400 mb-2">{{ drug.license_number }}</p>
                        <p class="text-sm text-gray-600 mb-2">{{ drug.englishName || '無英文名稱' }}</p>
                        <div class="space-y-1 mb-3">
                            <div v-if="drug.shape" class="flex items-center">
                                <span class="text-xs text-gray-500">形狀: {{ drug.shape }}</span>
                            </div>
                            <div v-if="drug.color" class="flex items-center">
                                <span class="text-xs text-gray-500">顏色: {{ drug.color }}</span>
                            </div>
                        </div>
                        <button @click="viewDrugDetails(drug)"
                            class="block w-full text-center py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                            查看詳情
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分頁 -->
            <div class="flex justify-center mt-8">
                <nav class="inline-flex rounded-md shadow">
                    <a href="#"
                        class="py-2 px-4 bg-white border border-gray-300 text-sm font-medium rounded-l-md hover:bg-gray-50">1</a>
                    <a href="#"
                        class="py-2 px-4 bg-white border-t border-b border-gray-300 text-sm font-medium hover:bg-gray-50">2</a>
                    <a href="#"
                        class="py-2 px-4 bg-white border border-gray-300 text-sm font-medium rounded-r-md hover:bg-gray-50">下一頁</a>
                </nav>
            </div>
        </div>

        <!-- 藥物詳情頁 -->
        <div v-if="activePage === 'detail'" class="container mx-auto px-4 py-8">
            <div class="mb-4">
                <button @click="setActivePage('search')"
                    class="flex items-center text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-arrow-left mr-2"></i> 返回搜尋結果
                </button>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="md:flex">
                    <!-- 藥物圖片 -->
                    <div class="md:w-1/3 p-6">
                        <div class="bg-gray-100 p-2 rounded-lg">
                            <img v-if="selectedDrug.imageUrl" :src="selectedDrug.imageUrl" :alt="selectedDrug.name" class="w-full h-auto rounded-lg">
                            <div v-else class="w-full h-64 bg-gray-200 flex items-center justify-center rounded-lg">
                                <span class="text-gray-400">無圖片</span>
                            </div>
                        </div>
                        <p class="text-center text-sm text-gray-500 mt-2">藥物圖片</p>
                    </div>

                    <!-- 藥物基本信息 -->
                    <div class="md:w-2/3 p-6">
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">{{ selectedDrug.name }}</h1>
                        <p class="text-sm text-gray-400 mb-4">{{ selectedDrug.license_number }}</p>
                        <p class="text-lg text-gray-600 mb-6">{{ selectedDrug.englishName || '無英文名稱' }}</p>

                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="space-y-2">
                                <p class="text-gray-600"><span class="font-semibold">形狀:</span> {{ selectedDrug.shape || '未提供' }}</p>
                                <p class="text-gray-600"><span class="font-semibold">顏色:</span> {{ selectedDrug.color || '未提供' }}</p>
                                <p class="text-gray-600"><span class="font-semibold">特殊劑型:</span> {{ selectedDrug.special_dosage_form || '未提供' }}</p>
                                <p class="text-gray-600"><span class="font-semibold">特殊氣味:</span> {{ selectedDrug.special_odor || '未提供' }}</p>
                            </div>
                            <div class="space-y-2">
                                <p class="text-gray-600"><span class="font-semibold">刻痕:</span> {{ selectedDrug.mark || '未提供' }}</p>
                                <p class="text-gray-600"><span class="font-semibold">外觀尺寸:</span> {{ selectedDrug.size || '未提供' }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 藥物詳細信息 -->
                <div class="border-t border-gray-200 px-6 py-4">
                    <div v-if="selectedDrug.indications" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">適應症</h2>
                        <p class="text-gray-600">{{ selectedDrug.indications }}</p>
                    </div>

                    <div v-if="selectedDrug.dosage" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">用法用量</h2>
                        <p class="text-gray-600">{{ selectedDrug.dosage }}</p>
                    </div>

                    <div v-if="selectedDrug.side_effects" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">副作用</h2>
                        <p class="text-gray-600">{{ selectedDrug.side_effects }}</p>
                    </div>

                    <div v-if="selectedDrug.contraindications" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">禁忌症</h2>
                        <p class="text-gray-600">{{ selectedDrug.contraindications }}</p>
                    </div>

                    <div v-if="selectedDrug.precautions" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">注意事項</h2>
                        <p class="text-gray-600">{{ selectedDrug.precautions }}</p>
                    </div>

                    <div v-if="selectedDrug.ingredient" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">主要成分</h2>
                        <p class="text-gray-600">{{ selectedDrug.ingredient }}</p>
                    </div>

                    <div v-if="selectedDrug.category" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">藥品分類</h2>
                        <p class="text-gray-600">{{ selectedDrug.category }}</p>
                    </div>

                    <div v-if="selectedDrug.storage_conditions" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">儲存條件</h2>
                        <p class="text-gray-600">{{ selectedDrug.storage_conditions }}</p>
                    </div>

                    <div v-if="selectedDrug.expiry_info" class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 mb-2">有效期限資訊</h2>
                        <p class="text-gray-600">{{ selectedDrug.expiry_info }}</p>
                    </div>

                    <div v-if="!selectedDrug.indications && !selectedDrug.dosage && !selectedDrug.side_effects && !selectedDrug.contraindications && !selectedDrug.precautions" class="text-gray-500 text-center py-4">
                        暫無臨床資訊
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖片辨識結果頁 -->
        <div v-if="activePage === 'recognition'" class="container mx-auto px-4 py-8">
            <div class="mb-4">
                <button @click="setActivePage('home')" class="flex items-center text-indigo-600 hover:text-indigo-800">
                    <i class="fas fa-arrow-left mr-2"></i> 返回首頁
                </button>
            </div>

            <h1 class="text-2xl font-bold mb-6">圖片辨識結果</h1>

            <div class="bg-white rounded-lg shadow-md overflow-hidden p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">已上傳圖片:</h2>
                <div class="flex justify-center">
                    <img :src="previewImage" alt="已上傳藥物圖片" class="h-48 rounded-lg">
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">最可能匹配的藥物:</h2>
                <div class="md:flex items-start">
                    <div class="md:w-1/4 mb-4 md:mb-0 md:mr-6">
                        <img :src="recognitionResult.bestMatch.imageUrl" :alt="recognitionResult.bestMatch.name"
                            class="w-full rounded-lg">
                    </div>
                    <div class="md:w-3/4">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold">{{ recognitionResult.bestMatch.name }}</h3>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm">相似度: {{
                                recognitionResult.bestMatch.similarity }}</span>
                        </div>
                        <p class="text-gray-600 mb-1"><span class="font-semibold">英文名:</span> {{
                            recognitionResult.bestMatch.englishName }}</p>
                        <p class="text-gray-600 mb-1"><span class="font-semibold">主要成分:</span> {{
                            recognitionResult.bestMatch.ingredient }}</p>
                        <p class="text-gray-600 mb-4"><span class="font-semibold">藥品分類:</span> {{
                            recognitionResult.bestMatch.category }}</p>
                        <button @click="viewDrugDetails(recognitionResult.bestMatch)"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                            查看詳情
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden p-6">
                <h2 class="text-lg font-semibold mb-4">其他可能的匹配結果:</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="(match, index) in recognitionResult.otherMatches" :key="index"
                        class="border border-gray-200 rounded-lg overflow-hidden">
                        <img :src="match.imageUrl" :alt="match.name" class="w-full h-32 object-cover">
                        <div class="p-3">
                            <h3 class="font-semibold mb-1">{{ match.name }}</h3>
                            <p class="text-sm text-gray-500 mb-2">相似度: {{ match.similarity }}</p>
                            <button @click="viewDrugDetails(match)"
                                class="w-full text-center py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded transition">
                                查看詳情
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-6">
                <p class="text-gray-600 mb-3">未找到匹配的藥物？</p>
                <div class="space-x-4">
                    <button @click="setActivePage('search')"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded transition">手動搜索</button>
                    <button @click="resetUpload"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded transition">重新上傳</button>
                </div>
            </div>
        </div>
        <!-- 處理中遮罩與進度條（放在 #app 內，確保 Vue 能渲染模板） -->
        <div v-if="isRecognizing" class="overlay">
            <div class="bg-white rounded-xl shadow-xl w-96 p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-spinner fa-spin text-indigo-600 mr-3"></i>
                    <h3 class="text-lg font-semibold">正在辨識，請稍候…</h3>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 mb-2 overflow-hidden">
                    <div class="bg-indigo-600 h-3" :style="{ width: progressPercent + '%' }"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600 mb-4">
                    <span>進度：{{ progress.done }}/{{ progress.total || '?' }}</span>
                    <span>{{ progressPercent.toFixed(0) }}%</span>
                </div>
                <div class="flex gap-2">
                    <button @click="cancelRecognition" class="flex-1 py-2 rounded-md border border-gray-300 hover:bg-gray-50">取消</button>
                    <button disabled class="flex-1 py-2 rounded-md bg-indigo-600 text-white opacity-70">辨識中</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue
        // 動態偵測後端 API 位址：預設使用同源（本機/Ngrok 皆適用）
        // 如需指定外部 API，可在瀏覽器 Console 設定：localStorage.setItem('API_BASE', 'https://your-ngrok.ngrok-free.dev')
        const API_BASE = (function () {
            const saved = localStorage.getItem('API_BASE')
            if (saved) return saved
            return window.location.origin
        })()

        createApp({
            data() {
                return {
                    activePage: 'home',
                    searchQuery: '',
                    previewImage: null,
                    imageFile: null,
                    recognitionMode: 'auto',  // 辨識模式: auto, feature, ocr, prescription
                    selectedShape: '',  // 選擇的形狀
                    selectedColor: '',  // 選擇的顏色
                    // 鎖定與進度
                    isRecognizing: false,
                    requestId: null,
                    progress: { done: 0, total: 0, status: 'idle' },
                    progressTimer: null,
                    abortController: null,
                    commonDrugs: [
                        '易克痛',
                        '抑炎',
                        '止痛',
                        '感冒',
                        '咳',
                        '胃腸',
                        '消炎',
                        '鎮痛',
                        '普拿疼',
                        '阿斯匹林'
                    ],
                    recentSearches: [],
                    searchResults: [],
                    selectedDrug: {
                        id: 1,
                        name: '阿斯匹林',
                        englishName: 'Aspirin',
                        category: '消炎止痛藥',
                        imageUrl: 'https://via.placeholder.com/300x200?text=阿斯匹靈',
                        ingredient: '乙醯水楊酸',
                        form: '錠劑',
                        manufacturer: '拜耳藥廠',
                        indications: '用於緩解輕至中度疼痛、發熱、關節炎、風濕病等症狀。',
                        dosage: '成人口服,一次1-2錠,每4-6小時一次,每日最多不超過12錠。',
                        sideEffects: '可能引起胃腸不適、消化道出血等。長期大量使用可能影響肝功能。',
                        contraindications: '對水楊酸類藥物過敏者禁用,消化性潰瘍活動期、出血傾向患者慎用。',
                        precautions: '服藥期間避免飲酒,兒童感冒發熱慎用。有高血壓、心臟病等基礎疾病患者使用前應諮詢醫師。'
                    },
                    recognitionResult: {
                        bestMatch: {
                            id: 1,
                            name: '阿斯匹靈',
                            englishName: 'Aspirin',
                            category: '消炎止痛藥',
                            imageUrl: 'https://via.placeholder.com/300x200?text=阿斯匹靈',
                            ingredient: '乙醯水楊酸',
                            similarity: '92%'
                        },
                        otherMatches: [
                            {
                                id: 5,
                                name: '布洛芬',
                                englishName: 'Ibuprofen',
                                category: '非類固醇消炎藥',
                                imageUrl: 'https://via.placeholder.com/300x200?text=布洛芬',
                                similarity: '65%'
                            },
                            {
                                id: 6,
                                name: '對乙醯氨基酚',
                                englishName: 'Paracetamol',
                                category: '解熱鎮痛藥',
                                imageUrl: 'https://via.placeholder.com/300x200?text=對乙醯氨基酚',
                                similarity: '48%'
                            }
                        ]
                    }
                }
            },
            methods: {
                setActivePage(page) {
                    this.activePage = page
                },
                triggerFileInput() {
                    this.$refs.fileInput.click()
                },
                handleFileChange(e) {
                    const file = e.target.files[0]
                    if (file && file.type.match('image.*')) {
                        this.imageFile = file
                        const reader = new FileReader()
                        reader.onload = (e) => {
                            this.previewImage = e.target.result
                        }
                        reader.readAsDataURL(file)
                    }
                },
                async searchDrug() {
                    if (this.searchQuery.trim()) {
                        // 自動拆分關鍵字（中文詞、數字、英文）
                        let raw = this.searchQuery.trim()
                        // 以非字母數字分隔,或中文詞分割
                        let keywords = raw.match(/([\u4e00-\u9fa5]+|[A-Za-z0-9]+)/g)
                        let queryStr = keywords ? keywords.join(' ') : raw

                        // 記錄最近搜尋
                        if (!this.recentSearches.includes(this.searchQuery)) {
                            this.recentSearches.unshift(this.searchQuery)
                            if (this.recentSearches.length > 5) {
                                this.recentSearches.pop()
                            }
                        }
                        // 呼叫後端 API
                        try {
                            const res = await fetch(`${API_BASE}/api/search/name?q=${encodeURIComponent(queryStr)}`)
                            
                            // 檢查是否是 HTML 回應（ngrok 提示頁面）
                            const contentType = res.headers.get('content-type')
                            if (contentType && contentType.includes('text/html')) {
                                alert('⚠️ 偵測到 ngrok 提示頁面\n\n請先在新分頁開啟以下網址，點擊 "Visit Site"：\n' + API_BASE + '\n\n然後回來重新搜尋。')
                                this.searchResults = []
                                return
                            }
                            
                            const data = await res.json()
                            if (data.success) {
                                // 將 API 回傳資料轉換為前端顯示格式
                                this.searchResults = data.data.map(drug => {
                                    // 取第一張圖片
                                    let imageUrl = ''
                                    if (drug.images && drug.images.length > 0) {
                                        imageUrl = `${API_BASE}/images/${drug.images[0].image_filename}`
                                    }
                                    return {
                                        id: drug.id,
                                        license_number: drug.license_number,
                                        name: drug.chinese_name,
                                        englishName: drug.english_name,
                                        shape: drug.shape,
                                        color: drug.color,
                                        special_dosage_form: drug.special_dosage_form,
                                        special_odor: drug.special_odor,
                                        mark: drug.mark,
                                        size: drug.size,
                                        label_front: drug.label_front,
                                        label_back: drug.label_back,
                                        imageUrl,
                                        images: drug.images
                                    }
                                })
                            } else {
                                this.searchResults = []
                            }
                        } catch (err) {
                            console.error('搜尋錯誤:', err)
                            alert('❌ 搜尋失敗\n\n可能原因：\n1. ngrok 伺服器未運行\n2. 網路連線問題\n3. 需要先訪問 ngrok 網址授權\n\n請確認本機 Flask 和 ngrok 都在運行中。')
                            this.searchResults = []
                        }
                        this.activePage = 'search'
                    }
                },
                async identifyDrug() {
                    if (!this.imageFile) {
                        alert('請先選擇圖片')
                        return
                    }
                    if (this.isRecognizing) return
                    
                    // 顯示載入中
                    const loadingMsg = `辨識中（${this.recognitionMode === 'auto' ? '自動判斷' : this.recognitionMode}模式），請稍候...`
                    console.log(loadingMsg)
                    
                    try {
                        // 建立請求 ID 用於取消/進度
                        this.requestId = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2))
                        this.isRecognizing = true
                        this.progress = { done: 0, total: 0, status: 'running' }
                        // 輪詢進度
                        this.progressTimer = setInterval(async () => {
                            try {
                                const res = await fetch(`${API_BASE}/api/progress/${this.requestId}`, { cache: 'no-store' })
                                const j = await res.json()
                                if (j.success) {
                                    this.progress = { done: j.done, total: j.total, status: j.status }
                                    if (j.status === 'done' || j.status === 'canceled') {
                                        clearInterval(this.progressTimer); this.progressTimer = null
                                    }
                                }
                            } catch {}
                        }, 500)

                        // 啟動請求
                        this.abortController = new AbortController()

                        // 建立 FormData 上傳圖片
                        const formData = new FormData()
                        formData.append('image', this.imageFile)
                        formData.append('top_k', '5')
                        formData.append('model', this.recognitionMode)  // auto, feature, ocr, prescription
                        formData.append('request_id', this.requestId)
                        
                        // 加入形狀和顏色過濾條件
                        if (this.selectedShape) {
                            formData.append('shape', this.selectedShape)
                        }
                        if (this.selectedColor) {
                            formData.append('color', this.selectedColor)
                        }
                        
                        // 呼叫辨識 API
                        const res = await fetch(`${API_BASE}/api/recognize`, {
                            method: 'POST',
                            body: formData,
                            signal: this.abortController.signal
                        })
                        
                        const data = await res.json()
                        
                        if (data.success && data.data && data.data.length > 0) {
                            // 轉換辨識結果為前端格式
                            const bestMatch = data.data[0]
                            const otherMatches = data.data.slice(1)
                            
                            // 構建最佳匹配
                            this.recognitionResult.bestMatch = {
                                id: bestMatch.id,
                                name: bestMatch.chinese_name,
                                englishName: bestMatch.english_name,
                                license_number: bestMatch.license_number,
                                shape: bestMatch.shape,
                                color: bestMatch.color,
                                special_dosage_form: bestMatch.special_dosage_form,
                                imageUrl: bestMatch.images && bestMatch.images.length > 0 
                                    ? `${API_BASE}/images/${bestMatch.images[0].image_filename}` 
                                    : '',
                                similarity: bestMatch.similarity_percent,
                                method: data.method || '特徵比對'
                            }
                            
                            // 構建其他匹配
                            this.recognitionResult.otherMatches = otherMatches.map(match => ({
                                id: match.id,
                                name: match.chinese_name,
                                englishName: match.english_name,
                                license_number: match.license_number,
                                shape: match.shape,
                                color: match.color,
                                imageUrl: match.images && match.images.length > 0 
                                    ? `${API_BASE}/images/${match.images[0].image_filename}` 
                                    : '',
                                similarity: match.similarity_percent
                            }))
                            
                            // 切換到辨識結果頁面
                            this.activePage = 'recognition'
                        } else if (data.success && data.matched_drugs) {
                            // 藥單模式結果
                            alert(`成功識別 ${data.matched_drugs_count} 個藥物！\n檢測到的文字：${data.detected_texts.map(t => t.text).join(', ')}`)
                        } else {
                            alert(data.message || '辨識失敗，請確保圖片清晰')
                        }
                    } catch (err) {
                        console.error('辨識錯誤:', err)
                        if (err.name === 'AbortError') {
                            // 已取消
                        } else {
                            alert('辨識過程發生錯誤，請稍後再試')
                        }
                    } finally {
                        this.isRecognizing = false
                        if (this.progressTimer) { clearInterval(this.progressTimer); this.progressTimer = null }
                        this.abortController = null
                    }
                },
                async cancelRecognition() {
                    if (!this.isRecognizing || !this.requestId) return
                    try {
                        this.abortController?.abort()
                        await fetch(`${API_BASE}/api/cancel`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ request_id: this.requestId }),
                            keepalive: true
                        })
                    } catch {}
                },
                viewDrugDetails(drug) {
                    // 如果已經有完整資料（例如從辨識結果），直接顯示
                    if (drug.indications !== undefined || drug.dosage !== undefined) {
                        this.selectedDrug = drug
                        this.activePage = 'detail'
                        return
                    }
                    
                    // 否則從 API 獲取完整資料
                    fetch(`${API_BASE}/api/drug/${drug.id}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                // 轉換為前端格式
                                const drugData = data.data
                                let imageUrl = ''
                                if (drugData.images && drugData.images.length > 0) {
                                    imageUrl = `${API_BASE}/images/${drugData.images[0].image_filename}`
                                }
                                
                                this.selectedDrug = {
                                    id: drugData.id,
                                    license_number: drugData.license_number,
                                    name: drugData.chinese_name,
                                    englishName: drugData.english_name,
                                    shape: drugData.shape,
                                    color: drugData.color,
                                    special_dosage_form: drugData.special_dosage_form,
                                    special_odor: drugData.special_odor,
                                    mark: drugData.mark,
                                    size: drugData.size,
                                    label_front: drugData.label_front,
                                    label_back: drugData.label_back,
                                    indications: drugData.indications,
                                    dosage: drugData.dosage,
                                    side_effects: drugData.side_effects,
                                    contraindications: drugData.contraindications,
                                    precautions: drugData.precautions,
                                    ingredient: drugData.ingredient,
                                    category: drugData.category,
                                    manufacturer: drugData.manufacturer,
                                    storage_conditions: drugData.storage_conditions,
                                    expiry_info: drugData.expiry_info,
                                    imageUrl,
                                    images: drugData.images
                                }
                                this.activePage = 'detail'
                            } else {
                                alert('無法獲取藥物詳細資訊')
                            }
                        })
                        .catch(err => {
                            console.error('獲取藥物詳情錯誤:', err)
                            alert('載入藥物詳情失敗')
                        })
                },
                resetUpload() {
                    this.previewImage = null
                    this.imageFile = null
                    this.activePage = 'home'
                }
            }
            ,
            computed: {
                progressPercent() {
                    const { done, total } = this.progress
                    if (!total || total <= 0) return 5 // 不確定總量時給個最小進度
                    return Math.min(100, Math.max(0, (done / total) * 100))
                }
            },
            mounted() {
                // 頁面關閉/刷新時嘗試通知後端取消
                window.addEventListener('beforeunload', () => {
                    if (this.isRecognizing && this.requestId) {
                        try {
                            navigator.sendBeacon(
                                `${API_BASE}/api/cancel`,
                                new Blob([JSON.stringify({ request_id: this.requestId })], { type: 'application/json' })
                            )
                        } catch {}
                    }
                })
            }
        }).mount('#app')
    </script>
</body>

</html>
